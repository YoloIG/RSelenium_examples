library(stringr)
library(RSelenium)
library(dplyr)
library(Rcurl)
library(XML)

############ IMPORTANTE###################################################

# Este proyecto únicamente tiene fines educativos. Por favor, 
# absténganse de usuarlo para fines distintos a los establecidos.

# El presente proyecto es una propuesta de crawling de información
# desde Facebook. Favor de verificar información input relevante.

############ Información input relevante ###################################################

# Para poder ejecutar esta sintaxis, es necesario proporcionar usuario y contraseña:
# Favor de ingresarlo en las siguientes variables:
usuario='xxx@xxxxx'
password='xxxxx'
  
#############################################################################


Sexo<-NULL
Sexo$hombre=0
Sexo$mujer=0

# Iniciar servidor
rD <- rsDriver(port=4895L, browser="phantomjs")
remDr <-rD$client



#Ingresar a Facebook, para esto se necesitan los datos de usuario y contraseÃ±a.

remDr$navigate("https://www.facebook.com/")
Sys.sleep(3)
webElems <- remDr$findElement("name","email")
a<-webElems
a$clickElement()
a$sendKeysToElement(list(usuario))

webElems <- remDr$findElement("name","pass")
a<-webElems
a$clickElement()
a$sendKeysToElement(list(password))
Sys.sleep(3)
webElems <- remDr$findElement("name","login")
a<-webElems
a$clickElement()

Sys.sleep(5)
remDr$screenshot(display=TRUE)
##########################################################################


#Navegar al grupo de Programacion en R
remDr$navigate("https://www.facebook.com/groups/1906504086251604/members/")

#para saber cuantos miembros son
webElems <- remDr$findElement("partial link text","(")
TextoCuantos<-str_replace(as.character(webElems$getElementText()),"[.]","")
total<-as.integer(str_sub(TextoCuantos,str_locate(TextoCuantos, '[(]')[1]+1,
        str_length(TextoCuantos)-1))

#Se obtienen 100 resultados en cada vista

totalVistas=as.integer(total/100)

#Empezar con las listas de miembros
paravistas<-1:totalVistas
final<-lapply(paravistas, function(x)
{
remDr$navigate("https://www.facebook.com/")
remDr$navigate("https://www.facebook.com/groups/1906504086251604/members/")

print(paste0("Extrer informacion de la vista de mimebros numero: ", x))

ventanas<-1:x

datos<- lapply(ventanas,function(x)
{
  webElems <- remDr$findElement("partial link text","Ver m")
  webElems$getElementText()
  webElems$clickElement() 
  print(x)
  Sys.sleep(3)
  
})

print("Extraer lista completa de usuarios en la vista...")
doc<-htmlParse(remDr$getPageSource()[[1]])
tabladat<-as.data.frame(readHTMLTable(doc)[x], Encoding='UTFddd-8')
tabladat %>% mutate_if(is.factor, as.character) ->tabladat
tabladat$vista<-x
print("Integrar lista completa de usuarios Ãºnicos en la vista...")
names(tabladat)<-c("lista1","lista2", "ventana")
tabladat$nombre<-substr(tabladat$lista1,1,str_locate(tabladat$lista1," "))
tabladat1<-tabladat[,c("nombre", "ventana")]
tabladat2<-tabladat[,c("nombre", "ventana")]
tabladatf<-unique(rbind(tabladat1,tabladat2))

#Empezamos a revisar cada nombre

nombre<-tabladatf$nombre

Sexo_total<-lapply(nombre,function(x)
{

print("Iniciar recoleccion usuario por usuario...")
print(paste0("Buscar nombre que comienza con ",x))
remDr$navigate("https://www.facebook.com/groups/1906504086251604/members/")

llegar_ventana<- lapply(ventanas,function(x)
{
  webElems <- remDr$findElement("partial link text","Ver m")
  webElems$getElementText()
  webElems$clickElement() 
  Sys.sleep(3)
  print("Llegar a la ventana de vista del miembro dentro del grupo...")
})



webElems_inicio <- remDr$findElements("partial link text",x)
print(paste0("Indentificar total de usuarios con el mismo inicio de nombre ",x))
a<-sapply(webElems_inicio, function(x){x$getElementAttribute('text')})
#nombre<-a[[1]]
#print(a)
print(x)

webElems_inicio<-webElems
i=0

inicio<-x

Sexo<-lapply(a, function(x){
  
i=i+1
print(paste0("Explorar cada coincidencia ",x))
nombre<-x
remDr$navigate("https://www.facebook.com/groups/1906504086251604/members/")


#Necesitamos llegar a la ventana donde el nombre es visible
llegar_ventana<- lapply(ventanas,function(x)
{
  webElems <- remDr$findElement("partial link text","Ver m")
  webElems$getElementText()
  webElems$clickElement() 
  Sys.sleep(3)
  print("Llegar a la ventana de vista del miembro dentro del grupo...")
})

webElems_incio <- remDr$findElements("partial link text",inicio)
print("Ubicar usuario...")
webElems_incio[[i]]$clickElement() 


print("Identificar informacion del usuario...")
Sys.sleep(3)
webElems <- remDr$findElement("partial link text","Info")
webElems$clickElement() 
Sys.sleep(3)
doc<-htmlParse(remDr$getPageSource()[[1]])
text <- xpathSApply(doc, "//text()[not(ancestor::script)][not(ancestor::style)][not(ancestor::noscript)][not(ancestor::form)]", xmlValue)

if(is.na(match("Mujer",text)) && is.na(match("Hombre",text))) 
{
  
#en caso de utilizar Chrome, estas instrucciones tienen que usarse
webElems <- remDr$findElement("partial link text","y de con")
Sys.sleep(3)
webElems$clickElement() 
webElems <- remDr$findElement("partial link text","y de con")
Sys.sleep(3)
webElems$clickElement()
doc<-htmlParse(remDr$getPageSource()[[1]])
text <- xpathSApply(doc, "//text()[not(ancestor::script)][not(ancestor::style)][not(ancestor::noscript)][not(ancestor::form)]", xmlValue)
print("Usuario programado con otra ventana")
}

print("Verirficar genero...")

if(!is.na(match("Mujer",text)))
{
  Sexo$mujer=Sexo$mujer+1
  print("Usuario es mujer.")
}

if(!is.na(match("Hombre",text)))
{
  Sexo$hombre=Sexo$hombre+1
  print("Usuario es hombre.")
}

return(Sexo)


})

return(Sexo)

})

return(Sexo_total)

})
